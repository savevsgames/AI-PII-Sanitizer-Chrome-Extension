!function(){console.log("üõ°Ô∏è AI PII Sanitizer: Loading..."),console.log("üåê Current hostname:",window.location.hostname),console.log("üåê Current URL:",window.location.href);const e=window.fetch;window.__nativeFetch=e;let t=!1,o=!1,n=0,s=1e3;async function i(){return new Promise(e=>{const t=Math.random().toString(36),o=setTimeout(()=>{window.removeEventListener("message",n),e(!1)},500),n=s=>{"ai-pii-content-health"===s.data?.source&&s.data?.messageId===t&&(clearTimeout(o),window.removeEventListener("message",n),e(!0===s.data.isAlive))};window.addEventListener("message",n),window.postMessage({source:"ai-pii-inject-health",messageId:t},"*")})}!async function e(){if(t)return void console.log("‚ö†Ô∏è Extension disabled - stopping health monitoring");const r=o;o=await i(),o?(r||console.log("‚úÖ PROTECTED - Extension connection active"),n=0,s=1e3):(n++,n<3&&(console.warn(`‚ö†Ô∏è Health check failed (attempt ${n}/3), retrying...`),await new Promise(e=>setTimeout(e,200)),o=await i()),o||(r&&(console.error("üõë NOT PROTECTED - Extension connection lost"),console.error("‚ö†Ô∏è Please refresh the page (Ctrl+Shift+R) to restore protection")),s=Math.min(2*s,3e5))),setTimeout(e,s)}();let r=!1;document.addEventListener("visibilitychange",async()=>{if("visible"===document.visibilityState){if(t)return void console.log("‚ö†Ô∏è Extension disabled - skipping protection check");if(console.log("üëÅÔ∏è Tab became visible, checking protection status..."),!await i()&&!r){console.warn("‚ö†Ô∏è Tab focused but NOT PROTECTED - showing modal");const o=await new Promise(e=>{const t=Math.random().toString(36),o=setTimeout(()=>{window.removeEventListener("message",n),e(null)},3e4),n=s=>{"ai-pii-content-not-protected"===s.data?.source&&s.data?.messageId===t&&(clearTimeout(o),window.removeEventListener("message",n),e(s.data.action))};window.addEventListener("message",n),window.postMessage({source:"ai-pii-inject-not-protected",messageId:t},"*")});r=!0,"reload"===o?console.log("üîÑ User chose reload from tab focus modal"):"disable"===o&&(console.log("‚ö†Ô∏è User chose disable - stopping all interception"),t=!0,window.fetch=e,console.log("‚úÖ Extension disabled - fetch restored to native"))}}});const a=["api.openai.com","backend-api/conversation","backend-api/f/conversation","claude.ai/api/organizations","gemini.google.com/_/BardChatUi","perplexity.ai/socket.io","perplexity.ai/api","perplexity.ai/rest","poe.com/api","copilot.microsoft.com/api","sydney.bing.com/sydney","you.com/api"];function c(e){return a.some(t=>e.includes(t))}if(window.fetch=async function(...o){if(t)return e.apply(this,o);const[n,s]=o,i="string"==typeof n?n:n.toString();if(window.location.hostname.includes("gemini.google.com")&&(console.log("üåê [DEBUG] All Gemini fetch:",i),console.log("üåê [DEBUG] isAIRequest?",c(i))),!c(i))return e.apply(this,o);console.log("üîí AI PII Sanitizer: Intercepting",i),i.includes("gemini.google.com")&&(console.log("üîç [Gemini] Request detected!"),console.log("üîç [Gemini] URL:",i),console.log("üîç [Gemini] Method:",s?.method||"GET"));try{const t=s?.body||"",n=await new Promise(e=>{const o=Math.random().toString(36),n=t=>{"ai-pii-content"===t.data?.source&&t.data?.messageId===o&&(window.removeEventListener("message",n),e(t.data.response))};window.addEventListener("message",n),window.postMessage({source:"ai-pii-inject",messageId:o,type:"SUBSTITUTE_REQUEST",payload:{body:t,url:i}},"*")});if(!n||!n.success){const e=n?.error||"Unknown error";throw console.error("‚ùå Substitution failed:",e),console.error("üõë BLOCKING REQUEST - Extension protection unavailable"),new Error(`AI PII Sanitizer: Protection failed (${e}). Request blocked for your safety. Please refresh the page (Ctrl+Shift+R) to restore protection.`)}if(n.needsWarning){console.warn("‚ö†Ô∏è API Key detected - showing warning modal");const t=await new Promise(e=>{const t=Math.random().toString(36),o=setTimeout(()=>{window.removeEventListener("message",s),e("block")},3e4),s=n=>{"ai-pii-content-warning"===n.data?.source&&n.data?.messageId===t&&(clearTimeout(o),window.removeEventListener("message",s),e(n.data.allow))};window.addEventListener("message",s),window.postMessage({source:"ai-pii-inject-warning",messageId:t,keysDetected:n.keysDetected,keyTypes:n.keyTypes},"*")});if("block"===t)return console.log("üõ°Ô∏è User blocked API key transmission"),new Response(JSON.stringify({error:"Request blocked by user"}),{status:403,statusText:"Forbidden - API Key Blocked",headers:{"Content-Type":"application/json"}});if("allow-all"===t)return console.log("‚ö†Ô∏è User allowed everything - ALL PROTECTION DISABLED"),e.apply(this,o);"allow-key-only"===t&&console.log("üîë User allowed API key only - PII still protected")}console.log("‚úÖ Request substituted:",n.substitutions,"replacements");const r=(s?.method||"GET").toUpperCase(),a={...s};"GET"!==r&&"HEAD"!==r&&(a.body=n.modifiedBody);const c=await e(i,a);if((c.headers.get("content-type")||"").includes("text/event-stream"))return console.log("‚ö° Streaming response detected"),async function(e){const t=e.body.getReader(),o=new TextDecoder,n=new ReadableStream({async start(e){for(;;){const{done:n,value:s}=await t.read();if(n)break;const i=o.decode(s,{stream:!0}),r=await new Promise(e=>{const t=Math.random().toString(36),o=setTimeout(()=>{window.removeEventListener("message",n),console.warn("‚ö†Ô∏è Chunk substitution timeout"),e({success:!1,error:"timeout"})},1e3),n=s=>{"ai-pii-content"===s.data?.source&&s.data?.messageId===t&&(clearTimeout(o),window.removeEventListener("message",n),e(s.data.response))};window.addEventListener("message",n),window.postMessage({source:"ai-pii-inject",messageId:t,type:"SUBSTITUTE_RESPONSE",payload:{text:i}},"*")}),a=r?.success?r.modifiedText:i;e.enqueue((new TextEncoder).encode(a))}e.close()}});return new Response(n,{status:e.status,statusText:e.statusText,headers:e.headers})}(c);const l=await c.text(),d=await new Promise(e=>{const t=Math.random().toString(36),o=n=>{"ai-pii-content"===n.data?.source&&n.data?.messageId===t&&(window.removeEventListener("message",o),e(n.data.response))};window.addEventListener("message",o),window.postMessage({source:"ai-pii-inject",messageId:t,type:"SUBSTITUTE_RESPONSE",payload:{text:l}},"*")});return d&&d.success?(console.log("‚úÖ Response decoded:",d.substitutions,"replacements"),new Response(d.modifiedText,{status:c.status,statusText:c.statusText,headers:c.headers})):(console.warn("‚ö†Ô∏è Response substitution failed, returning original"),new Response(l,{status:c.status,statusText:c.statusText,headers:c.headers}))}catch(e){throw console.error("‚ùå AI PII Sanitizer:",e),e}},console.log("üõ°Ô∏è AI PII Sanitizer: Active and monitoring"),window.location.hostname.includes("gemini.google.com")){console.log("[Gemini XHR] Initializing XHR interception for Gemini");const e=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,o,...n){return this._interceptor={url:"string"==typeof o?o:o.toString(),method:t.toUpperCase(),shouldIntercept:!1},"POST"===t.toUpperCase()&&(this._interceptor.url.includes("BardChatUi")||this._interceptor.url.includes("batchexecute"))&&(this._interceptor.shouldIntercept=!0,console.log("[Gemini XHR] Will intercept:",t,this._interceptor.url)),e.apply(this,[t,o,...n])},XMLHttpRequest.prototype.send=function(e){const n=this._interceptor;if(!n||!n.shouldIntercept)return o.apply(this,[e]);if(console.log("[Gemini XHR] üîí Intercepting request"),console.log("[Gemini XHR] URL:",n.url),console.log("[Gemini XHR] Body length:",e?.length||0),console.log("[Gemini XHR] Body preview:",e?.substring(0,200)),t)return console.warn("[Gemini XHR] Extension disabled - passing through"),o.apply(this,[e]);const s=this;(async()=>{try{const t=e?String(e):"",i=await new Promise(e=>{const o=Math.random().toString(36),s=setTimeout(()=>{window.removeEventListener("message",i),console.error("[Gemini XHR] Request substitution timeout"),e({success:!1,error:"timeout"})},5e3),i=t=>{"ai-pii-content"===t.data?.source&&t.data?.messageId===o&&(clearTimeout(s),window.removeEventListener("message",i),e(t.data.response))};window.addEventListener("message",i),window.postMessage({source:"ai-pii-inject",messageId:o,type:"SUBSTITUTE_REQUEST",payload:{body:t,url:n.url}},"*")});if(!i||!i.success)return console.error("[Gemini XHR] ‚ùå Substitution failed, blocking request"),void setTimeout(()=>{const e=new Event("error");s.dispatchEvent(e)},0);console.log("[Gemini XHR] ‚úÖ Request substituted:",i.substitutions,"replacements");const r=s.onreadystatechange;s.onreadystatechange=async function(e){if(this.readyState===XMLHttpRequest.DONE)try{const e=this.responseText;console.log("[Gemini XHR] üîì Intercepting response"),console.log("[Gemini XHR] Response length:",e.length),console.log("[Gemini XHR] Response preview:",e.substring(0,200));const t=await new Promise(t=>{const o=Math.random().toString(36),n=setTimeout(()=>{window.removeEventListener("message",s),console.warn("[Gemini XHR] Response substitution timeout"),t({success:!1,error:"timeout"})},5e3),s=e=>{"ai-pii-content"===e.data?.source&&e.data?.messageId===o&&(clearTimeout(n),window.removeEventListener("message",s),t(e.data.response))};window.addEventListener("message",s),window.postMessage({source:"ai-pii-inject",messageId:o,type:"SUBSTITUTE_RESPONSE",payload:{text:e}},"*")});t&&t.success?(console.log("[Gemini XHR] ‚úÖ Response decoded:",t.substitutions,"replacements"),Object.defineProperty(this,"responseText",{value:t.modifiedText,writable:!1,configurable:!0}),Object.defineProperty(this,"response",{value:""===this.responseType||"text"===this.responseType?t.modifiedText:this.response,writable:!1,configurable:!0})):console.warn("[Gemini XHR] ‚ö†Ô∏è Response substitution failed, returning original")}catch(e){console.error("[Gemini XHR] ‚ùå Response handling error:",e)}r&&r.call(this,e)},o.call(s,i.modifiedBody)}catch(t){console.error("[Gemini XHR] ‚ùå Interception error:",t),o.call(s,e)}})()},console.log("[Gemini XHR] ‚úÖ XHR interception initialized for Gemini")}if(window.location.hostname.includes("copilot.microsoft.com")){console.log("[Copilot WS] üöÄ Initializing WebSocket interception for Copilot");const e=window.WebSocket,o=WebSocket.prototype.send,n=WebSocket.prototype.addEventListener,s=new WeakMap;window.WebSocket=function(t,o){console.log("[Copilot WS] WebSocket created:",t);const n=new e(t,o);return t.includes("/c/api/chat")?(console.log("[Copilot WS] ‚úÖ Copilot chat WebSocket detected - will intercept"),s.set(n,{url:t,shouldIntercept:!0,messageBuffer:[]})):console.log("[Copilot WS] ‚è≠Ô∏è  Non-chat WebSocket - passing through"),n},window.WebSocket.prototype=e.prototype,window.WebSocket.CONNECTING=e.CONNECTING,window.WebSocket.OPEN=e.OPEN,window.WebSocket.CLOSING=e.CLOSING,window.WebSocket.CLOSED=e.CLOSED,WebSocket.prototype.send=function(e){const n=s.get(this);if(!n||!n.shouldIntercept)return o.call(this,e);if(t)return console.warn("[Copilot WS] Extension disabled - passing through"),o.call(this,e);console.log("[Copilot WS] üîí Intercepting outgoing message"),console.log("[Copilot WS] Message length:",e?.length||0),console.log("[Copilot WS] Message preview:","string"==typeof e?e.substring(0,500):e);const i=this;(async()=>{try{const t="string"==typeof e?e:String(e),s=await new Promise(e=>{const o=Math.random().toString(36),s=setTimeout(()=>{window.removeEventListener("message",i),console.error("[Copilot WS] Request substitution timeout"),e({success:!1,error:"timeout"})},5e3),i=t=>{"ai-pii-content"===t.data?.source&&t.data?.messageId===o&&(clearTimeout(s),window.removeEventListener("message",i),e(t.data.response))};window.addEventListener("message",i),window.postMessage({source:"ai-pii-inject",messageId:o,type:"SUBSTITUTE_REQUEST",payload:{body:t,url:n.url,method:"WEBSOCKET"}},"*")});s?.success?(console.log("[Copilot WS] ‚úÖ Sending modified message"),console.log("[Copilot WS] Substitutions:",s.substitutions||0),o.call(i,s.modifiedBody)):(console.error("[Copilot WS] ‚ùå Substitution failed, sending original"),o.call(i,e))}catch(t){console.error("[Copilot WS] ‚ùå Interception error:",t),o.call(i,e)}})()},WebSocket.prototype.addEventListener=function(e,t,o){const i=s.get(this);return"message"===e&&i&&i.shouldIntercept?(console.log("[Copilot WS] üì® Intercepting onmessage handler"),n.call(this,e,async function(e){try{return console.log("[Copilot WS] üì© Message received:",e.data?.substring(0,200)),t.call(this,e)}catch(o){return console.error("[Copilot WS] ‚ùå Message interception error:",o),t.call(this,e)}},o)):n.call(this,e,t,o)},console.log("[Copilot WS] ‚úÖ WebSocket interception initialized for Copilot")}}();